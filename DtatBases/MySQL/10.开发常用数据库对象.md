# 开发常用数据库对象

## 视图

​	MySQL 从6.0.1版本开始提供视图功能，本节将对MySQL中的视图进行介绍。

### 什么是视图

​	视图（View） 是一种虚拟存在的表，对于使用视图的用户来说基本上是透明的。视图并不在数据库中实际存在，行和列数据来自定义视图的查询中使用的表，并且是在使用视图时动态生成的。

​	视图相对于普通的表的优势主要包括以下几项。

+ 简单：使用视图的用户完全不需要关心后面对应的表的结构、关联条件和筛选条件、对用户来说已经是过滤好的符合条件的结果集。
+ 安全：使用视图的用户只能访问他们被允许查询的结果集，对表的权限管理并不能限制到某个行某个列，但是通过视图就可以简单的实现。
+ 数据独立：一旦视图的结构确定了，可以屏蔽表结构变化对用户的影响，源表增加列对视图没有影响；源表修改列名，则可以通过修改视图来解决，不会照成对访问者的影响。

### 视图操作

​	视图的操作包括创建或者修改视图、删除视图，以及查看视图定义。

### 创建或者修改视图

​	创建视图需要有 CREATE VIEW 的权限，并且对于查询涉及的列有 SELECT 权限。如果使用 CREATE OR REPLACE 或者 ALTER 修改视图，那么还需要该视图的 DROP 权限。

​	创建视图的语法如下：

```mysql
CREATE [OR REPLACE] [ALGORITHM = {UNDEFINED | MERGE | TEMPTABLE}] 
	VIEW view_name [(column_list)] 
	AS select_statement 
	[WITH [CASCADED | LOCAL] CHECK OPTION] 
```

​	修改视图的语法如下：

```mysql
ALTER [ALGORTIHM = {UNDEFINED | MERGE | TEMPTABLE}]
	VIEW view_name [(COLUMN_LIST)]
	AS select_statement
	[WITH [CASCADED | LOCAL] CHECK OPTION]
```

​	例如，要创建视图 staff_list_view，可以使用以下命令：

```mysql
mysql> CREATE OR REPLACE VIEW staff_list_view as select s.staff_id,s.first_name,s.last_name,a.address from staff as s,address as a where s.address_id = a.address_id;
Query OK, 0 rows affected (0.01 sec)
```

​		MySQL 视图的定义有一些限制，例如，在 5.7.7 版本之前，FROM 关键字后面不能包含子查询，这和其他数据库是不同的，如果视图是从其它数据库迁移过来的，那么可能需要因此做一些改动。

​	视图的可更新性和视图中查询的定义有关系，以下类型的视图是不可更新的。

+ 包含以下关键字的SQL 语句：聚合函数（SUM、MIN、MAX 、COUNT 等）、DISTINCT、GROUP BY 、HAVING、UNION 或者 UNION ALL
+ 常量视图。
+ SELECT 中包含子查询
+ JOIN
+ FROM 一个不能更新的视图
+ WHERE 字句的子查询引用了FROM 字句中的表

例如，以下的视图都是不可更新的：

```mysql
-- 包含聚合函数
create or replace view payment_sum as select staff_id, sum(amount) from payment group by staff_id;

-- 常量函数
create or replace view pi as select 3.1415926 as pi;

-- select 中包含子查询
create view city_view as select (select city from city where city_id = 1);
```

​	WITH [CASCADED | LOCAL] CHECK OPTION 决定了是否允许更新数据使记录不再满足视图的条件。这个选项与 Oracle 数据库中的选项是类似的，其中：

+ LOCAL 只要满足本视图的条件就可以更新。
+ CASCADED 则必须满足所有针对该视图的所有视图的条件才可以更新。

如果没有明确是 LOCAL 还是 CASCADED ，则默认是 CASCADED。