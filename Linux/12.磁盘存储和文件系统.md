lsmod

lsblk -f查看分区

blkid 查看分区和文件系统类型

tune2fs -l /dev/sda1 查看块设备的元数据(创建文件系统之后使用)

init 1 单用户

init 3 字符

init 5图形

## 2.2 文件系统

### **2.2.1 文件系统概念**

文件系统是操作系统用于明确存储设备或分区上的文件的方法和数据结构;即在存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件结构称为文件管理系统，简称文件系统。

从系统角度来看，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行保护和检索的系统。具体地说，它负责为用户建立文件，存入、读出、修改、转储文件，控制文件的存取，安全控制，日志，压缩,加密等

支持的文件系统:

```bash
/lib/modules/`uname -r`/kernel/fs
```

各种文件系统：[https://wiki.deepin.org/wiki/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F](https://wiki.deepin.org/wiki/文件系统)

帮助：man 5 fs

### 2.2.2文件系统类型

```
#查看文件系统类型
df -T
```



**Linux常用文件系统**

<table>
    <tr>
    	<td>ext2</td>
        <td>Extended file system 适用于那些分区容量不是太大，更新也不频繁的情况，列如/boot 分区</td>
    </tr>
    <tr>
    	<td>ext3</td>
        <td>是ext2的改进版本，其支持日志功能，能够帮助系统从非正常关机导致的异常中恢复</td>
    </tr>
    <tr>
    	<td>ext4</td>
        <td>是ext文件系统的最新版，提供了很多新的特性，包括纳秒级时间戳、创建和使用巨型文件（16TB），最大1EB的文件系统，以及速度的提升</td>
    </tr>
    <tr>
    	<td>xfs</td>
        <td>SGI，支持最大8EB的文件系统</td>
    </tr>
    <tr>
    	<td>swap</td>
        <td>交换分区，虚拟内存</td>
    </tr>
    <tr>
    	<td>iso9660</td>
        <td>光盘</td>
    </tr>
    <tr>
    	<td>btrfs</td>
        <td>Oracle</td>
    </tr>
    <tr>
    	<td>relserfs</td>
        <td></td>
    </tr>
</table>

**Windows 常用文件系统**

<table>
    <tr>
    	<td>FAT32</td>
        <td></td>
    </tr>
    <tr>
    	<td>NTFS</td>
        <td></td>
    </tr>
    <tr>
    	<td>exFAT</td>
        <td></td>
    </tr>
</table>

**Unix**

<table>
    <tr>
    	<td>FFS</td>
        <td>fast</td>
    </tr>
    <tr>
    	<td>UFS</td>
        <td>unix</td>
    </tr>
    <tr>
    	<td>IFS2</td>
        <td></td>
    </tr>
</table>

**网络文件系统**

<table>
    <tr>
    	<td>NFS</td>
        <td></td>
    </tr>
    <tr>
    	<td>CIFS</td>
        <td></td>
    </tr>
</table>

**集群文件系统**

<table>
    <tr>
    	<td>GFS2</td>
        <td></td>
    </tr>
    <tr>
    	<td>OCFS2</td>
        <td>Oracle</td>
    </tr>
</table>

**分布式文件系统**

<table>
    <tr>
    	<td>fastdfs</td>
        <td></td>
    </tr>
    <tr>
    	<td>ceph</td>
        <td></td>
    </tr>
    <tr>
    	<td>moosefs</td>
        <td></td>
    </tr>
    <tr>
    	<td>mogilefs</td>
        <td></td>
    </tr>
    <tr>
    	<td>glusterfs</td>
        <td></td>
    </tr>
    <tr>
    	<td>Lustre</td>
        <td></td>
    </tr>
</table>

**RAW**

​	未经处理，或者未经格式化产生的文件系统

**常用的文件系统特性**

<table>
    <tr>
    	<td>FAT32</td>
        <td>最多只能支持16TB的文件系统和4GB的文件</td>
    </tr>
    <tr>
    	<td>NTFS</td>
        <td>最多只能支持16EB的文件系统和16EB的文件</td>
    </tr>
    <tr>
    	<td>EXT3</td>
        <td>1.最多只能支持32TB的文件系统和2TB的文件，实际只能容纳2TB的文件系统和16GB的文件<br>
        2.Ext3目前只支持32000个子目录<br>
        3.Ext3文件系统使用32位空间记录块数量和inode数量<br>
        4.当数据写入到Ext3文件系统中时，Ext3的数据块分配器每次只能分配一个4KB的块    
        </td>
    </tr>
    <tr>
    	<td>EXT4</td>
        <td>1.EXT4是Linux系统下的日志文件系统，是EXT3文件系统的后继版本<br>
        2.EXT4的文件系统容量达到1EB，而支持单个文件则达到16TB<br>
        3.理论上支持无限数量的子目录<br>
        4.EXT4文件系统使用64位空间记录块数量和inode数量<br>
        5.EXT4的多块分配器支持一次调用分配多个数据块
        <br>
        6.修复速度更快    
        </td>
    </tr>
    <tr>
    	<td>XFS</td>
        <td>1.根据所记录的日志在很短的时间内迅速恢复磁盘文件内容<br>
        2.用优化算法，日志记录对整体文件操作影响非常小
        <br>3.是一个全64-bit的文件系统，最大可以支持8EB的文件系统，而支持单个文件则达到8EB
        <br>4.能以接近裸设备I/O的性能存储数据</td>
    </tr>
</table>

目前支持的文件系统：

```bash
cat /proc/filesystems
```



### 2.2.3 文件系统的组成部分

```bash
#查看已经加载在内存中的文件系统
lsmod
```



+ 内核中的模块：ext4，xfs，vfat
+ Linux的虚拟文件系统：VFS
+ 用户矿建的管理工具：mkfs.ext4, mkfs.xfs, mkfs.vfat

![1585101527020](..\\typora-user-images\1585101527020.png)



### 2.2.4 文件系统选择管理

#### 2.2.4.1 创建文件系统

**创建文件管理工具**

<table>
    <tr>
        <td rowspan="2">mkfs命令</td>
        <td>mkfs.FS_TYPE /dev/DEVICE
        <br>ext4
        <br>xfs
        <br>btrfs
        <br>vfat</td>
    </tr>
    <tr>
        <td>mkfs -t FS_TYPE /dev/DEVICE
        <br>-L 'LABEL' 设定卷标</td>
    </tr>
    <tr>
    	<td>mke2fs</td>
        <td>ext系列文件系统专用管理工具</td>
    </tr>
</table>

**常用选项**

<table style="width:100%">
    <tr>
    	<td style="width:45%;">-t {ext2|ext3|ext4}</td>
        <td>指定文件系统类型</td>
    </tr>
     <tr>
    	<td>-b {1024|2048|4096}</td>
        <td>指定块大小</td>
    </tr>
     <tr>
    	<td>-L 'LABEL'</td>
        <td>设置卷标</td>
    </tr>
     <tr>
    	<td>-j</td>
        <td>相当于 -t ext3，mkfs.ext3 = mkfs -t ext3 = mke2fs -j = mke2fs -t ext3</td>
    </tr>
     <tr>
    	<td>-i #</td>
        <td>为数据空间中每多少个字节创建一个inode；不应该小于block大小</td>
    </tr>
     <tr>
    	<td>-N #</td>
        <td>指定分区中创建多少个inode</td>
    </tr>
     <tr>
    	<td>-l</td>
        <td>一个inode记录占用的磁盘空间大小，128...4096</td>
    </tr>
     <tr>
    	<td>-m #</td>
        <td>默认5%，为管理人员预留空间占总空间的百分比</td>
    </tr>
     <tr>
    	<td>-O FEATURE[.....]</td>
        <td>启用指定特性</td>
    </tr>
    <tr>
    	<td>-O ^FEATURE[.....]</td>
        <td>关闭指定特性</td>
    </tr>
</table>



#### 2.2.4.2 查看和管理分区信息



<table>
    <tr>
    	<td>查看块设备属性信息</td>
        <td>blkid</td>
    </tr>
    <tr>
    	<td>格式</td>
        <td>blkid [OPTION]...[DEVICE]</td>
    </tr>
    <tr>
    	<td  rowspan="2">常用选项</td>
        <td>-U UUID	根据指定的UUID来查找对应的设备</td>
    </tr>
    <tr>
        <td>-L LABEL	根据指定的LABEL来查找对应的设 </td>
</tr>
 </table>



<table>
    <tr>
    	<td>e2label</td>
        <td>管理ext系列文件系统的LABEL</td>
    </tr>
    <tr>
    	<td>格式</td>
        <td>e2label DEVICE [LABEL]</td>
    </tr>
</table>



<table>
    <tr>
    	<td>findfs</td>
        <td>查找分区</td>
    </tr>
    <tr>
        <td rowspan="2">格式</td>
    	<td>findfs [options] LABEL=label</td>
    </tr>
    <tr>
    	<td>findfs [options] UUID=uuid</td>
    </tr>
</table>



<table>
    <tr>
    	<td>tune2fs</td>
        <td>重新设定ext系列文件系统可调整参数的值</td>
    </tr>
    <tr>
    	<td rowspan="10">常用选项</td>
        <td>-l 查看指定文件系统超级块信息：super block</td>
    </tr>
    <tr>
    	<td>-L 'LABEL' 修改卷标</td>
    </tr>
    <tr>
    	<td>-m # 修改留给管理员的空间百分比</td>
    </tr>
    <tr>
    	<td>-j 将ext2升级为ext3</td>
    </tr>
    <tr>
    	<td>-O 文件系统属性启用或禁用，-O ^has_journal</td>
    </tr>
    <tr>
    	<td>-o  调整文件系统的默认挂载选项，-o ^acl</td>
    </tr>
    <tr>
    	<td>-U UUID 修改UUID号</td>
    </tr>
</table>



<table>
     <tr>
    	<td>dumpe2fs</td>
         <td> 显示ext文件系统信息，将磁盘块分组管理</td>
    </tr>
    <tr>
        <td>选项</td>
    	<td>-h 查看超级块信息，不显示分组信息</td>
    </tr>
    </table>





<table>
     <tr>
    	<td>xfs_info</td>
         <td>显示已挂载的xfs文件系统信息</td>
    </tr>
    <tr>
    	<td>格式</td>
        <td>xfs_info mountpoint | devname</td>
    </tr>
</table>









**超级块个INODE TABLE**

![1585185647810](..\\typora-user-images\1585185647810.png)



**2.2.4.3 文件系统检测和修复**

文件系统夹故障常发生于死机或者正常关机之后，挂载为文件系统标记为“no clean”

注意：一定不要在挂载状态下执行命令修复。

**fsck**:File  System Check

```bash
fsck.FS_TYPE
fsck -t FS_TYPE
```

注意：FS_TYPE 一定要与分区上已经文件类型相同

常用选项：

+ -a	自动修复
+ -r     交互式修复错误



**e2fsck**：ext系列文件专用的检测修复工具

+  -y	自动回答为yes
+ -f      强制修复
+ -p    自动进行安全的修复文件系统问题



**xfs_repair**:xfs文件系统专用检测修复工具

常用选项：

+ -f    修复文件而设备
+ -n    只检查
+ -d    允许修复只读的挂载设备，在单用户下修复时使用，然后立即reboot



### 2.3 挂载

挂载：将额外文件系统与根文件系统某现存的目录建立关联关系，进而使得此目录作为其它文件访问入口的行为。

卸载：为解除此关联关系的过程



把设备关联挂载点：mount Point

挂载点下原有文件在挂载完成后会被临时隐藏，因此，挂载点目录一般为空

进程正在使用中的设备无法被挂载

#### 2.3.1 挂载文件系统 mount

格式：

```bash
mount [-fnrsvw] [-t vfstype] [-o options] device dir
```

device：指明要挂载的设备

+ 设备文件：例如/dev/sda5
+ 卷标：-L ‘LABEL’，例如-L ‘MYDATA’
+ UUID：-U ‘UUID’ 例如 -U ‘fa846700-2ffa-41f8-85d9-0f47152f051e’
+ 为文件系统名称：proc,sysfs，devtmpfs，configfs

dir：挂载点

​	事先存在，建议使用空目录

mount常用命令选项

<table style="width:100%">
    <tr>
    	<td style="width:30%">-t vsftype</td>
        <td>指定要挂载的设备上的文件系统类型</td>
    </tr>
    <tr>
    	<td>-r</td>
        <td>readonly,只读挂载</td>
    </tr>
    <tr>
    	<td>-w</td>
        <td>read and write,读写挂载</td>
    </tr>
    <tr>
    	<td>-n</td>
        <td>不更新/etc/mtab,mount不可见</td>
    </tr>
    <tr>
    	<td>-a</td>
        <td>自动挂载所有支持自动挂载的设备（定义在了/etc/fstab文件中，且挂载选项中有auto功能）</td>
    </tr>
    <tr>
    	<td>-L 'LABEL'</td>
        <td>以卷标指定挂载设备</td>
    </tr>
    <tr>
    	<td>-U 'UUID'</td>
        <td>以UUID指定要挂载的设备</td>
    </tr>
    <tr>
    	<td>-B， --bind</td>
        <td>绑定目录到另一个目录上</td>
    </tr>
    <tr>
    	<td rowspan="15">-o options</td>
        <td>（挂载文件系统的选项）多个选项使用逗号分隔</td>
    </tr>
    <tr>
        <td>async:异步模式（内存更改时，写入缓存区buffer，过一段时间再写到磁盘中）；sync同步模式，内存更改时，同时写磁盘</td>
    </tr>
    <tr>
        <td>atime/noatime:包含目录和文件</td>
    </tr>
    <tr>
        <td>diratime/nodiratime：目录的访问时间戳</td>
    </tr>
    <tr>
        <td>auto/noauto:是否支持自动挂载，是否支持-a选项</td>
    </tr>
    <tr>
        <td>exec/noexec:是否支持将文件系统上运行应用程序</td>
    </tr>
    <tr>
        <td>dev/nodev:是否支持在此文件系统上使用设备文件</td>
    </tr>
    <tr>
        <td>suid/nosuid:是否支持suid和sgid权限</td>
    </tr>
    <tr>
        <td>remount:重新挂载</td>
    </tr>
    <tr>
        <td>ro:只读；rw：读写</td>
    </tr>
    <tr>
        <td>user/nouser:是否允许普通用户挂载此设备，/etc/fstab使用</td>
    </tr>
    <tr>
        <td>acl:启用此文件系统上的acl功能</td>
    </tr>
    <tr>
        <td>loop：启用loop设备</td>
    </tr>
    <tr>
        <td>_netdev:当网络可用时才对网络资源进行挂载，如：NFS文件系统</td>
    </tr>
    <tr>
        <td>defaults：相当于rw，suid，dev,exec,auto,nouser,async</td>
    </tr>
</table>

**挂载规则：**

+ 一个挂载点同一时间只能挂载一个设备
+ 一个挂载点同一时间挂载了多个设备，只能看到最后一个设备的数据，其它设备上的数据将被隐藏
+ 一个设备可以同时挂载到多个挂载点
+ 通常一个挂载点一般是已存在的空的目录



#### 2.3.2 卸载文件系统 umount

卸载时：可使用设备，也可以使用挂载点

```bash
umount 设备名 | 挂载点
```

#### 2.3.3 查看挂载情况

查看挂载

```bash
#通过查看/etc/mtab 文件显示当前已挂载的所有设备
mount
# 查看内核追踪到的已挂载的所有设备
cat /proc/mounts
```

查看挂载点情况

```bash
findmnt MOUNT_POINT | device
```

查看正在访问指定文件系统的进程

```bash
lsof MOUNT_POINT
fuser -v MOUNT_POINT
```

