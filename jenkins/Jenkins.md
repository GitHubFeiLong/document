# Jenkins 持续集成入门到精通

## 1、持续集成Jenkins 介绍

### 软件开发生命周期

​		软件开发生命周期又叫做SDLC（Software Development Life Cycle），它是集合了计划、开发、测试和部署过程的集合。如下所示：

![image-20201129153240812](Jenkins.assets/image-20201129153240812.png)

+ 需求分析

  这时生命周期的第一阶段，根据项目需求，团队执行一个可行性计划的分析。项目需求可能是公司内部或者客户提出的。这阶段主要是对信息的收集，也有可能是对现有项目的改善和重新做一个新的项目。还要分析项目的预算多长，可以从哪方面受益以及布局，这也是项目创建的目标

+ 设计

  第二阶段就是设计阶段，系统架构和满意状态（就是做成什么样子，有什么功能），和创建一个项目计划可以使用图表，布局设计或者文字的方式呈现。

+ 实现

  第三阶段就是实现阶段，项目经理创建和分配工作给开发者，开发者根据任务和设计阶段定义的目标进行开发代码。依据项目的大小和复杂程度，可以需要数月或更长时间菜能完成。

+ 测试

  测试人员进行代码测试，包括功能测试、代码测试、压力测试等。

+ 进化

  最后阶段就是对产品不断的进化改进和维护阶段，根据用户的使用情况，可能需要对某功能进行修改，bug修复，功能增加等。

### 软件开发瀑布模型

​		瀑布模型是最著名和最常使用的软件开发模型。瀑布模型就是一系列的软件开发过程。它是由制造业繁衍出来的。一个高度化的结构流程在一个方向上流动，有点像生产线一样。在瀑布模型创建之初，没有其它开发的模型，有很多东西全靠开发人员去猜测，去开发。这样的模型仅适用于那些简单的软件开发，但是已经不适合现在的开发了。

​		下图对软件开发模型的一个阐述。

![image-20201129154304574](Jenkins.assets/image-20201129154304574.png)

| 优势                                       | 劣势                                                         |
| ------------------------------------------ | ------------------------------------------------------------ |
| 简单易用和理解                             | 各个阶段的划分完全固定，阶段之间产生大量的文档，极大的增加了工作量 |
| 当前一阶段完成后，您只需要去关注后续阶段。 | 由于开发模型是线性的，用户只有等到整个过程的末期才能见到成果，从而增加了开发风险 |
| 为项目提供了按阶段划分的检查节点           | 瀑布模型的突出缺点是不适应用户需求的变化。                   |

### 软件的敏捷开发

#### 什么是敏捷开发？

​		敏捷开发(Agile Deveiopment)的核心是迭代开发(lterative Development)与增量开发(IncrementalDevelopment)。

##### ===何为迭代开发?===

​		对于大型软件项目，传统的开发方式是采用一个大周期(比如一年)进行开发，整个过程就是一次"大开发";迭代开发的方式则不一样，它将开发过程拆分成多个小周期，即一次"大开发"变成多次"小开发"，每次小开发都是同样的流程，所以看上去就好像重复在做同样的步骤。

​		举例来说，SpaceX公司想造一个大推力火箭，将人类送到火星。但是，它不是一开始就造大火箭，而是先造一个最简陋的小火箭Falcon 1。结果，第一次发射就爆炸了，直到第四次发射，才成功进入轨道。然后，开发了中型火箭Falcon 9，九年中发射了70次。最后，才开发Falcon重型火箭。如果SpaceX不采用迭代开发，它可能直到现在还无法上天。

##### ===何为增量开发?===

​		软件的每个版本，都会新增一个用户可以感知的完整功能。也就是说，按照新增功能来划分迭代。

​		举例来说，房产公司开发一个10栋楼的小区。如果采用增量开发的模式，该公司第一个迭代就是交付一号楼，第二个迭代交付二号楼..…….每个迭代都是完成一栋完整的楼。而不是第一个迭代挖好10栋楼的地基，第二个迭代建好每栋楼的骨架，第三个迭代架设屋顶.....

#### 敏捷开发如何迭代？

​		虽然敏捷开发将软件开发分成多个迭代，但是也要求，每次迭代都是一个完整的软件开发周期，必须按照软件工程的方法论，进行正规的流程管理。

![image-20201129155328073](Jenkins.assets/image-20201129155328073.png)

#### 敏捷开发有什么好处？

##### ==早期交付==

​		敏捷开发的第一个好处，就是早期交付，从而大大降低成本。

​		还是以上一节的房产公司为例，如果按照传统的"瀑布开发模式"，先挖10栋楼的地基、再盖骨架、然后架设屋顶，每个阶段都等到前一个阶段完成后开始，可能需要两年才能一次性交付10栋楼。也就是说，如果不考虑预售，该项目必须等到两年后才能回款。

​		敏捷开发是六个月后交付一号楼，后面每两个月交付一栋楼。因此，半年就能回款10%，后面每个月都会有现金流，资金压力就大大减轻了。

##### ==降低风险===

​		敏捷开发的第二个好处是，及时了解市场需求，降低产品不适用的风险。

​		请想一想，哪一种情况损失比较小:10栋楼都造好以后，才发现卖不出去，还是造好第一栋楼，就发现卖不出去，从而改进或停建后面9栋楼?



### 什么是持续集成

​		持续集成（Continuous integration，简称Cl ）指的是，频繁地(一天多次）将代码集成到主干。

​		持续集成的目的，就是让产品可以快速迭代，同时还能保持高质量。它的核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成。

​		通过持续集成，团队可以快速的从一个功能到另一个功能，简而言之，敏捷软件开发很大一部分都要归功于持续集成。

#### ==持续集成的流程==

![image-20201129155832103](Jenkins.assets/image-20201129155832103.png)

​		根据持续集成的设计，代码从提交到生产，整个过程有以下几步。

+ 提交：流程的第一步，是开发者向代码仓库提交代码。所有后面的步骤都始于本地代码的一次提交（commit)。
+ 测试(第一轮)：代码仓库对commit操作配置了钩子(hook)，只要提交代码或者合并进主干，就会跑自动化测试。
+ 构建：通过第一轮测试，代码就可以合并进主干，就算可以交付了。交付后，就先进行构建(build)，再进入第二轮测试。所谓构建，指的是将源码转换为可以运行的实际代码比如安装依赖，配置各种资源(样式表、JS脚本、图片)等等。
+ 测试(第二轮)：构建完成，就要进行第二轮测试。如果第一轮已经涵盖了所有测试内容，第二轮可以省略，当然，这时构建步骤也要移到第一轮测试前面。
+ 部署：过了第二轮测试，当前代码就是一个可以直接部署的版本(artifact)。将这个版本的所有文件打包( tar filename.tar * )存档，发到生产服务器。
+ 回滚：一旦当前版本发生问题，就要回滚到上一个版本的构建结果。最简单的做法就是修改一下符号链接，指向上一个版本的目录。

#### 持续集成的组成要素

+ 一个自动构建过程，从检出代码、编译构建、运行测试、结果记录、测试统计等都是自动完成的，无需人工干预。

+ 一个代码存储库，即需要版本控制软件来保障代码的可维护性，同时作为构建过程的素材库，一般使用SVN或Git。

+ 一个持续集成服务器，Jenkins 就是一个配置简单和使用方便的持续集成服务器。

![image-20201129160530909](Jenkins.assets/image-20201129160530909.png)

#### 持续集成的好处

1、降低风险，由于持续集成不断去构建，编译和测试，可以很早期发现问题，所以修复的代价就少;

2、对系统健康持续检查，减少发布风险带来的问题;

3、减少重复性工作;

4、持续部署，提供可部署单元包;

5、持续交付可供使用的版本;

6、增强团队信心;

### Jenkins 介绍

![image-20201129161017486](Jenkins.assets/image-20201129161017486.png)

​		Jenkins是一款流行的开源持续集成(Continuous Integration)工具，广泛用于项目开发，具有自动化构建、测试和部署等功能。[官网](http://jenkins-ci.org)

Jenkins的特征:

+ 开源的Java语言开发持续集成工具，支持持续集成，持续部署。
+ 易于安装部署配置:可通过yum安装,或下载war包以及通过docker容器等快速实现安装部署，可方便web界面配置管理。
+ 消息通知及测试报告:集成RSS/E-mail通过RSS发布构建结果或当构建完成时通过e-mail通知，生成JUnit/TestNG测试报告。
+ 分布式构建:支持Jenkins能够让多台计算机一起构建/测试。
+ 文件识别:Jenkins能够跟踪哪次构建生成哪些jar，哪次构建使用哪个版本的jar等
+ 丰富的插件支持:支持扩展插件，你可以开发适合自己团队使用的工具，如git，svn，maven，docker等。

## 2、jenkins 安装和持续集成环境配置

### 持续集成流程说明

![image-20201129161943430](Jenkins.assets/image-20201129161943430.png)

1）首先，开发人员每天进行代码提交，提交到Git仓库。

2）然后，Jenkins作为持续集成工具，使用Git工具到Git仓库拉取代码到集成服务器，再配合JDK，Maven等软件完成代码编译，代码测试与审查，测试，打包等工作，在这个过程中每一步出错，都重新再执行一次整个流程。

3）最后，Jenkins把生成的jar或war包分发到测试服务器或者生产服务器，测试人员或用户就可以访问应用。

**服务器列表**

本课程虚拟机统—采用CentOS7

| 名称           | IP地址         | 安装的软件                                        |
| -------------- | -------------- | ------------------------------------------------- |
| 代码托管服务器 | 192.168.66.100 | Gitlab-12.4.2                                     |
| 持续集成服务器 | 192.168.66.101 | Jenkins-2.190.3，JDK1.8，Maven3.6.2，GT,SonarQube |
| 应用测试服务器 | 192.168.66.102 | JDK1.8，Tomcat8.5                                 |

### Gitlab代码托管服务器安装

#### Gitlab简介

![image-20201129162608364](Jenkins.assets/image-20201129162608364.png)

[官网](https://about.gitlab.coml/)

​		GitLab是一个用于仓库管理系统的开源项目，使用Git作为代码管理工具，并在此基础上搭建起来的web服务。

​		GitLab和GitHub一样属于第三方基于Git开发的作品，免费且开源（基于MIT协议)，与Github类似，可以注册用户，任意提交你的代码，添加SSHKey等等。不同的是，**GitLab是可以部署到自己的服务器上，数据库等一切信息都掌握在自己手上，适合团队内部协作开发**，你总不可能把团队内部的智慧总放在别人的服务器上吧?简单来说可把GitLab看作个人版的GitHub。

#### Gitlab安装

​		1.安装相关依赖

```bash
$ sudo yum -y install policycoreutils openssh-server openssh-clients postfix
```

​		2.启动ssh服务&设置为开机启动

```bash
$ sudo systemctl enable sshd && sudo systemctl start sshd
```

​		3.设置postfix开机自启，并启动，postfix支持gitlab发信功能

```bash
$ sudo systemctl enable postfix && systemctl start postfix
```

​		4.开放ssh以及http服务，然后重新加载防火墙列表

```bash
$ sudo firewall-cmd --add-service=ssh --permanent
$ sudo firewall-cmd --add-service=http --permanent
$ sudo firewall-cmd --reload
```

> 如果关闭防火墙就不需要做以上配置

​		5.下载gitlab包，并且安装

```bash
#在线下载安装包:
$ sudo wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el8/gitlab-ce-13.6.1-ce.0.el8.x86_64.rpm
#安装
$ sudo rpm -ivh gitlab-ce-13.6.1-ce.0.el8.x86_64.rpm
```

> 注意：
>
> 出现下面的错误，使用`yum install policycoreutils-python`
>
> ```text
> error: Failed dependencies:
> 	policycoreutils-python is needed by gitlab-ce-12.4.2-ce.0.el6.x86_64
> ```
>
> 如果执行还是不行，那么就是操作系统的版本不是centos7
>
> 在 https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el8/ 去下载对应centos8的版本。
>
> 参考 [解决policycoreutils-python is needed by问题_没有伞的孩子只能快跑，如若不跑，只有一个结果：超过你的人回头鄙视你-CSDN博客](https://blog.csdn.net/fu18838928050/article/details/107901895)

​		6.修改gitlab配置

```bash
$ sudo vim /etc/gitlab/gitlab.rb
```

> 修改gitlab访问地址和端口，默认为80，我们改为82
>
> ```bash
> external_url 'http://192.168.66.100:82'
> nginx['listen_port'] = 82
> ```

​		7.重载配置及启动gitlab

```bash
$ sudo gitlab-ctl reconfigure
$ sudo gitlab-ctl restart
```

​		8.把端口添加到防火墙

```bash
$ sudo firewall-cmd --zone=public --add-port=82/tcp --permanent
$ sudo firewall-cmd --reload
```

​		启动成功后，浏览器输入` ip:82 `看到以下修改管理员root密码的页面，修改密码后，然后登录即可

![image-20201129182809528](Jenkins.assets/image-20201129182809528.png)

> 用户名是 root
>
> 密码就是刚设置的8位密码



#### Gitlab添加组、创建用户、创建项目

​		1）创建组

​		使用管理员root创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理

> 点击Explore groups 进行创建group
>
> ![image-20201129183711374](Jenkins.assets/image-20201129183711374.png)
>
> ![image-20201129183922235](Jenkins.assets/image-20201129183922235.png)

​		2）创建用户

​		创建用户的时候，可以选择Regular或Admin类型。

> 创建：点击菜单栏的Admin Area
>
> ![image-20201129184349210](Jenkins.assets/image-20201129184349210.png)
>
> 
>
> 左边是项目相关，中间是用户相关，右边是组相关，
>
> ![image-20201129184517404](Jenkins.assets/image-20201129184517404.png)
>
> 我们点击中间 Users的New user，需要注意的是，Access 下有个 Access level 单选框，Regular 变时普通用户，只能访问属于他的组和项目；Admin：管理员，可以访问所有组和项目
>
> ![image-20201129184750447](Jenkins.assets/image-20201129184750447.png)
>
> 修改：创建完后，可以在用户列表的后面点击Edit进行修改密码等信息
>
> ![image-20201129185155020](Jenkins.assets/image-20201129185155020.png)



​		3）将用户添加到组中

​		选择某个用户组，进行Members管理组的成员

> 第一步，点击需要添加到的组名称
>
> ![image-20201129185509418](Jenkins.assets/image-20201129185509418.png)
>
> 第二部：点击右侧的Members
>
> ![image-20201129185544894](Jenkins.assets/image-20201129185544894.png)
>
> 第三步：选择用户和权限
>
> ![image-20201129190407015](Jenkins.assets/image-20201129190407015.png)
>
> Gitlab用户在组里面有5种不同权限:
>
> 1. Guest:可以创建issue、发表评论，不能读写版本库。
> 2. Reporter:可以克隆代码，不能提交，QA、PM可以赋予这个权限。
> 3. Developer:可以克隆代码、开发、提交、push，普通开发可以赋予这个权限。
> 4. Maintainer:可以创建项目、添加tag、保护分支、添加项目成员、编辑项目，核心开发可以赋予这个权限。
> 5. Owner:可以设置项目访问权限-Visibility Level、删除项目、迁移项目、管理组成员，开发组组长可以赋予这个权限

​		3）创建项目

​		使用新创建的账号进行创建项目

> 首先使用新用户登录，登陆成功后点击 New project![image-20201129190853422](Jenkins.assets/image-20201129190853422.png)
>
> 创建：
>
> ![image-20201129191141140](Jenkins.assets/image-20201129191141140.png)



### 源码上传到Gitlab仓库

​		下面来到DEA开发工具，我们已经准备好一个简单的Web应用准备到集成部署。我们要把源码上传到Gitlab的项目仓库中。	

​		1）项目结构说明

![image-20201129201918902](Jenkins.assets/image-20201129201918902.png)

​		我们建立了一个非常简单的web应用，只有一个index.jsp页面，如果部署好，可以访问该页面就成功啦!

​		2）开启版本控制

​		将项目文件提交到Gitlib上去

> 1. 首先是先初始化Git
>
> 2. 然后是将项目文件commit 提交
>
> 3. 提交过后就需要修改远程仓库
>
>    ![image-20201129204040055](Jenkins.assets/image-20201129204040055.png)
>
>    点击右边的 ”+“，新增一个远程仓库地址，地址从Gitlib project 复制
>
>    ![image-20201129204234250](Jenkins.assets/image-20201129204234250.png)
>
>    ![image-20201129204332926](Jenkins.assets/image-20201129204332926.png)
>
> ​	

13